#!/usr/bin/env php
<?php
declare(strict_types=1);

/**
 * MonkeysLegion CLI entry point.
 *
 * Installed per‐project as `vendor/bin/ml`
 * and re‐exported under `bin/ml` in the skeleton.
 */

// 1) Locate Composer's autoloader in either place
$autoloadCandidates = [
    __DIR__ . '/../vendor/autoload.php',   // skeleton: <project>/bin/vendor/autoload.php
    __DIR__ . '/../../../autoload.php',    // vendor:   <project>/vendor/autoload.php
];

$found = false;
foreach ($autoloadCandidates as $autoload) {
    if (file_exists($autoload)) {
        require_once $autoload;
        // Define project root: parent of the vendor folder
        // e.g. /path/to/my-app/vendor/autoload.php → /path/to/my-app
        define('ML_BASE_PATH', dirname(dirname($autoload)));
        $found = true;
        break;
    }
}

if (! $found) {
    fwrite(STDERR, "Error: could not locate Composer autoload.php\n");
    exit(1);
}

// 2) Build the DI container, passing in the array returned by config/app.php
$container = (new MonkeysLegion\DI\ContainerBuilder())
    ->addDefinitions(
        require ML_BASE_PATH . '/config/app.php'
    )
    ->build();

/*
|--------------------------------------------------------------------------
| Bootstrap the CLI kernel
|--------------------------------------------------------------------------
|
| Resolve the CliKernel, register commands, and hand off to the requested
| command (from $argv), or list available commands if none given.
|
*/

/** @var MonkeysLegion\Cli\CliKernel $kernel */
$kernel = $container->get(MonkeysLegion\Cli\CliKernel::class);
exit($kernel->run($argv));