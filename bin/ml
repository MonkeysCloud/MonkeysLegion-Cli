#!/usr/bin/env php
<?php
declare(strict_types=1);

/**
 * MonkeysLegion CLI entry point.
 *
 * Installed in every project as `vendor/bin/ml`
 * and re-exported by the skeleton under `bin/ml`.
 */

// 1) Find Composer's autoloader (either skeleton or vendor)
$autoloadCandidates = [
    __DIR__ . '/../vendor/autoload.php',   // skeleton/bin/ml
    __DIR__ . '/../../../autoload.php',    // vendor/monkeyscloud/.../bin/ml
];

$found = false;
foreach ($autoloadCandidates as $autoload) {
    if (file_exists($autoload)) {
        require_once $autoload;
        // project root = parent of the vendor folder
        define('ML_BASE_PATH', dirname(dirname($autoload)));
        $found = true;
        break;
    }
}

if (! $found) {
    fwrite(STDERR, "Error: Cannot locate Composer autoload.php.\n");
    exit(1);
}

// 2) Build the DI container, passing in the array from config/app.php
$container = (new MonkeysLegion\DI\ContainerBuilder())
    ->addDefinitions(require ML_BASE_PATH . '/config/app.php')
    ->build();

/*
|--------------------------------------------------------------------------
| Bootstrap the CLI kernel
|--------------------------------------------------------------------------
|
| Resolve the CliKernel, register commands, and delegate control
| to the command specified in $argv[1] (or list commands if none).
|
*/

/** @var MonkeysLegion\Cli\CliKernel $kernel */
$kernel = $container->get(MonkeysLegion\Cli\CliKernel::class);
exit($kernel->run($argv));